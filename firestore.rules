rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isConferenceOrganizer(conferenceId) {
      let confPath = /databases/$(database)/documents/conference/$(conferenceId);
      return request.auth != null
        && exists(confPath)
        && request.auth.token.email in get(confPath).data.organizerEmails;
    }

    function isSamePerson(personId) {
      let personPath = /databases/$(database)/documents/person/$(personId);
      return request.auth != null
        && exists(personPath)
        && request.auth.token.email == get(personPath).data.email;
    }

    function isPlatformAdmin() {
      let personPath = /databases/$(database)/documents/person/$(request.auth.uid);
      return request.auth != null
        && exists(personPath)
        && get(personPath).data.isPlatformAdmin == true;
    }

    function onlyPlatformAdminCanCreateConferenceEnabled() {
      let configPath = /databases/$(database)/documents/platform-config/PlatformConfig;
      return exists(configPath)
        && get(configPath).data.onlyPlatformAdminCanCreateConference == true;
    }

    // Firestore Rules does not support iterating a dynamic list with loops.
    // We check the first submitted conference ids explicitly (pragmatic bounded check).
    function isOrganizerOfAnySubmittedConferenceIds(submittedConferenceIds) {
      return request.auth != null
        && submittedConferenceIds is list
        && (
          (submittedConferenceIds.size() > 0 && isConferenceOrganizer(submittedConferenceIds[0])) ||
          (submittedConferenceIds.size() > 1 && isConferenceOrganizer(submittedConferenceIds[1])) ||
          (submittedConferenceIds.size() > 2 && isConferenceOrganizer(submittedConferenceIds[2])) ||
          (submittedConferenceIds.size() > 3 && isConferenceOrganizer(submittedConferenceIds[3])) ||
          (submittedConferenceIds.size() > 4 && isConferenceOrganizer(submittedConferenceIds[4])) ||
          (submittedConferenceIds.size() > 5 && isConferenceOrganizer(submittedConferenceIds[5])) ||
          (submittedConferenceIds.size() > 6 && isConferenceOrganizer(submittedConferenceIds[6])) ||
          (submittedConferenceIds.size() > 7 && isConferenceOrganizer(submittedConferenceIds[7])) ||
          (submittedConferenceIds.size() > 8 && isConferenceOrganizer(submittedConferenceIds[8])) ||
          (submittedConferenceIds.size() > 9 && isConferenceOrganizer(submittedConferenceIds[9]))
        );
    }

    function canOrganizerEditPersonFromExistingSubmissions() {
      return request.auth != null
        && resource.data.speaker is map
        && isOrganizerOfAnySubmittedConferenceIds(resource.data.speaker.submittedConferenceIds);
    }

    match /person/{document=**} {
      allow read; 
      allow update, create: if request.auth != null
        && (request.auth.token.email == resource.data.email
          || canOrganizerEditPersonFromExistingSubmissions());
      allow delete: if request.auth != null
      	&& request.auth.token.email == resource.data.email;
    }

    match /person_emails/{email} {
      // Index collection for email uniqueness
      // Only writable via Cloud Function transaction (createPerson)
      // Readable by Cloud Function only
      allow read, write: if false;
    }


    match /conference/{document=**} {
      allow read;
      allow update, delete: if request.auth != null 
      	&& request.auth.token.email in resource.data.organizerEmails;
      allow create:         if request.auth != null 
      	&& request.auth.token.email in request.resource.data.organizerEmails
        && (!onlyPlatformAdminCanCreateConferenceEnabled() || isPlatformAdmin());
    }
    match /platform-config/{documentId} {
      allow read;
      allow create, update, delete: if documentId == 'PlatformConfig' && isPlatformAdmin();
    }
    match /conferenceSecret/{document=**} {
      allow create: if isConferenceOrganizer(request.resource.data.conferenceId);
      allow read, update, delete: if isConferenceOrganizer(resource.data.conferenceId);
    }
    match /conference-hall-config/{document=**} {
      allow create: if isConferenceOrganizer(request.resource.data.conferenceId);
      allow read, update, delete: if isConferenceOrganizer(resource.data.conferenceId);
    }
    match /conference-speaker/{document=**} {
      allow create: if isConferenceOrganizer(request.resource.data.conferenceId);
      allow read, update, delete: if isConferenceOrganizer(resource.data.conferenceId);
    }
    match /conference-dashboard/{dashboardId} {
      allow read: if isConferenceOrganizer(resource.data.conferenceId);
      allow write: if false;
    }
    match /conference-dashboard/{dashboardId}/history/{historyId} {
      allow read: if isConferenceOrganizer(resource.data.conferenceId);
      allow write: if false;
    }


    match /session/{document=**} {
      allow create: if request.auth != null;
      allow update, delete: if isConferenceOrganizer(resource.data.conference.conferenceId)
      	|| (resource.data.conference == null && request.auth != null 
           && (isSamePerson(resource.data.spearker1Id))
      	       || isSamePerson(resource.data.spearker2Id)
      	       || isSamePerson(resource.data.spearker3Id)
              );
      allow read;
    }
    match /session-allocation/{document=**} {
      allow create: if isConferenceOrganizer(request.resource.data.conferenceId);
      allow read, update, delete: if isConferenceOrganizer(resource.data.conferenceId);
    }

    match /activity/{document=**} {
      allow create: if isConferenceOrganizer(request.resource.data.conferenceId);
      allow update, delete: if isConferenceOrganizer(resource.data.conferenceId);
      allow read;
    }

    match /activity-participation/{document=**} {
		  allow create: if isConferenceOrganizer(request.resource.data.conferenceId)
        || isSamePerson(request.resource.data.personId);
      allow read, update, delete: if isConferenceOrganizer(resource.data.conferenceId)
        || isSamePerson(resource.data.personId);
    }
    match /activityParticipation/{document=**} {
		  allow create: if isConferenceOrganizer(request.resource.data.conferenceId)
        || isSamePerson(request.resource.data.personId);
      allow read, update, delete: if isConferenceOrganizer(resource.data.conferenceId)
        || isSamePerson(resource.data.personId);
    }
    match /slot-type/{document=**} {
      allow read;
      allow write: if false;
    }
    match /voxxrin-config/{document=**} {
      allow create: if isConferenceOrganizer(request.resource.data.conferenceId);
      allow read, update, delete: if isConferenceOrganizer(resource.data.conferenceId);
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
