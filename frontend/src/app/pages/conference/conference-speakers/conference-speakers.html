<h2 class="page-title">
  {{
    'CONFERENCE.SPEAKERS.TITLE_PAGE'
      | translate
        : {
            conference: ((conference()?.name || '') + (conference()?.edition ? ' ' + conference()?.edition : '')).trim()
          }
  }}
</h2>

<p-dataview
  class="speaker-dataview"
  [value]="filteredSpeakerViews()"
  [paginator]="true"
  [rows]="10"
  layout="list"
  [loading]="loading()"
  [showCurrentPageReport]="true"
  currentPageReportTemplate="{first} - {last} / {totalRecords}"
>
  <ng-template #header>
    <div class="speaker-toolbar">
      <div class="toolbar-row row-1">
        <p-multiselect
          [options]="sessionTypeOptions()"
          [ngModel]="selectedSessionTypeIds()"
          (ngModelChange)="selectedSessionTypeIds.set($event)"
          optionLabel="label"
          optionValue="value"
          display="chip"
          [showToggleAll]="false"
          [placeholder]="'CONFERENCE.SPEAKERS.FILTER_SESSION_TYPE' | translate"
          class="header-control"
        ></p-multiselect>

        <input
          pInputText
          type="text"
          [ngModel]="searchText()"
          (ngModelChange)="searchText.set($event)"
          [placeholder]="'CONFERENCE.SPEAKERS.FILTER_SEARCH' | translate"
          class="header-control header-search"
        />
      </div>

      <div class="toolbar-row row-2">
        <div class="filter-checkbox">
          <p-checkbox
            inputId="has-unavailable-slot-filter"
            [binary]="true"
            [ngModel]="hasUnavailableSlotFilter()"
            (ngModelChange)="hasUnavailableSlotFilter.set(!!$event)"
          ></p-checkbox>
          <label for="has-unavailable-slot-filter">
            {{ 'CONFERENCE.SPEAKERS.FILTER_HAS_UNAVAILABLE_SLOT' | translate }}
          </label>
        </div>
        <div class="filter-checkbox">
          <p-checkbox
            inputId="has-multiple-sessions-filter"
            [binary]="true"
            [ngModel]="hasMultipleSessionsFilter()"
            (ngModelChange)="hasMultipleSessionsFilter.set(!!$event)"
          ></p-checkbox>
          <label for="has-multiple-sessions-filter">
            {{ 'CONFERENCE.SPEAKERS.FILTER_HAS_MULTIPLE_SESSIONS' | translate }}
          </label>
        </div>

        <div class="speaker-count">
          {{
            'CONFERENCE.SPEAKERS.COUNT'
              | translate
                : {
                    filtered: filteredSpeakerViews().length,
                    total: speakerViews().length
                  }
          }}
        </div>

        <button
          pButton
          type="button"
          icon="pi pi-plus"
          [label]="'CONFERENCE.SPEAKERS.ADD_SPEAKER' | translate"
          class="add-speaker-button"
          (click)="onAddSpeaker()"
        ></button>
      </div>
    </div>
  </ng-template>

  <ng-template #list let-items>
    <div class="speaker-list">
      @for (view of items; track view.conferenceSpeaker.id) {
        <div
          class="speaker-card"
          role="button"
          tabindex="0"
          (click)="openSpeakerEdit(view)"
          (keydown.enter)="openSpeakerEdit(view)"
          (keydown.space)="openSpeakerEdit(view); $event.preventDefault()"
          [class.missing-person]="!view.person"
        >
          <div class="speaker-line-1">
            <div class="speaker-main">
              <span class="speaker-name">
                {{ view.fullName || ('CONFERENCE.SPEAKERS.UNKNOWN_SPEAKER' | translate) }}
              </span>
              @if (view.company) {
                <span class="speaker-company">({{ view.company }})</span>
              }
              @if (view.person?.email) {
                <span class="speaker-email">{{ view.person?.email }}</span>
              }
            </div>
            <div class="speaker-meta">
              @if (view.unavailableSlotsCount > 0) {
                <span class="meta-badge">
                  {{ 'CONFERENCE.SPEAKERS.UNAVAILABLE_SLOTS' | translate }}
                </span>
              }
              @for (countByType of view.sessionTypeCounts; track countByType.sessionTypeId) {
                <span
                  class="meta-badge"
                  [style.background-color]="countByType.backgroundColor"
                  [style.color]="countByType.textColor"
                >
                  {{ countByType.sessionTypeLabel }}: {{ countByType.count }}
                </span>
              }
            </div>
          </div>
        </div>
      }
    </div>
  </ng-template>

  <ng-template #emptymessage>
    <div class="empty-message">{{ 'CONFERENCE.SPEAKERS.EMPTY' | translate }}</div>
  </ng-template>
</p-dataview>

<p-dialog
  [visible]="editDialogVisible()"
  [modal]="true"
  [closable]="true"
  position="top"
  styleClass="speaker-edit-dialog"
  [style]="{ width: '95vw', maxWidth: '900px' }"
  [header]="(createMode() ? 'CONFERENCE.SPEAKERS.EDIT.TITLE_CREATE' : 'CONFERENCE.SPEAKERS.EDIT.TITLE') | translate"
  (onHide)="closeSpeakerEdit()"
>
  @if (editingPerson(); as person) {
    @if (editingConferenceSpeaker(); as conferenceSpeaker) {
      <div class="edit-content">
        <div class="speaker-avatar-row">
          <p-avatar
            [image]="person.speaker?.photoUrl || ''"
            shape="circle"
            size="xlarge"
            [label]="!person.speaker?.photoUrl ? ((person.firstName[0] || '') + (person.lastName[0] || '')) : undefined"
          ></p-avatar>
        </div>
        <p-tabs [value]="0">
          <p-tablist>
            <p-tab [value]="0">{{ 'CONFERENCE.SPEAKERS.EDIT.TAB_PERSON' | translate }}</p-tab>
            <p-tab [value]="1">{{ 'CONFERENCE.SPEAKERS.EDIT.TAB_SPEAKER' | translate }}</p-tab>
            <p-tab [value]="2">{{ 'CONFERENCE.SPEAKERS.EDIT.TAB_AVAILABILITY' | translate }}</p-tab>
          </p-tablist>
          <p-tabpanels>
            <p-tabpanel [value]="0">
              <div class="form-grid">
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.FIRST_NAME' | translate }}</label>
                  <input pInputText [(ngModel)]="person.firstName" class="w-full" />
                  @if (!isRequiredTextFilled(person.firstName)) {
                    <small>{{ 'VALIDATION.REQUIRED' | translate }}</small>
                  }
                </div>
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.LAST_NAME' | translate }}</label>
                  <input pInputText [(ngModel)]="person.lastName" class="w-full" />
                  @if (!isRequiredTextFilled(person.lastName)) {
                    <small>{{ 'VALIDATION.REQUIRED' | translate }}</small>
                  }
                </div>
                <div class="form-group">
                  <label>{{ 'PERSON.EDIT.EMAIL' | translate }}</label>
                  <input pInputText [(ngModel)]="person.email" type="email" class="w-full" [disabled]="!createMode()" />
                  @if (!createMode()) {
                    <small>{{ 'PERSON.EDIT.EMAIL_DISABLED' | translate }}</small>
                  } @else if (!isRequiredTextFilled(person.email)) {
                    <small>{{ 'VALIDATION.REQUIRED' | translate }}</small>
                  }
                </div>
                <div class="form-group">
                  <label>{{ 'PERSON.EDIT.LANGUAGE' | translate }}</label>
                  <p-select
                    [(ngModel)]="person.preferredLanguage"
                    [options]="languageOptions()"
                    optionLabel="label"
                    optionValue="value"
                    [disabled]="!createMode()"
                    class="w-full"
                  ></p-select>
                </div>
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.COMPANY' | translate }}</label>
                  <input pInputText [(ngModel)]="person.speaker!.company" class="w-full" />
                </div>
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.PHOTO_URL' | translate }}</label>
                  <input pInputText [(ngModel)]="person.speaker!.photoUrl" class="w-full" />
                </div>
              </div>

              <div class="social-links">
                <h4>{{ 'CONFERENCE.SPEAKERS.EDIT.SOCIAL_LINKS' | translate }}</h4>
                @for (socialLink of person.speaker!.socialLinks; track $index) {
                  <div class="social-row">
                    <input pInputText [(ngModel)]="socialLink.network" [placeholder]="'CONFERENCE.SPEAKERS.EDIT.SOCIAL_NETWORK' | translate" />
                    <input pInputText [(ngModel)]="socialLink.url" [placeholder]="'CONFERENCE.SPEAKERS.EDIT.SOCIAL_URL' | translate" />
                    <button
                      pButton
                      type="button"
                      icon="pi pi-trash"
                      severity="danger"
                      [text]="true"
                      (click)="removeSocialLink($index)"
                    ></button>
                  </div>
                }
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  [label]="'CONFERENCE.SPEAKERS.EDIT.ADD' | translate"
                  severity="secondary"
                  (click)="addSocialLink()"
                ></button>
              </div>
            </p-tabpanel>
            <p-tabpanel [value]="1">
              <div class="form-grid">
                <div class="form-group full-row">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.REFERENCE' | translate }}</label>
                  <textarea pTextarea [(ngModel)]="person.speaker!.reference" rows="4" class="w-full"></textarea>
                </div>
                <div class="form-group full-row">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.BIO' | translate }}</label>
                  <textarea pTextarea [(ngModel)]="person.speaker!.bio" rows="4" class="w-full"></textarea>
                </div>
              </div>
            </p-tabpanel>
            <p-tabpanel [value]="2">
              <div class="availability-list">
                @for (dayAvailability of editingDayAvailabilities(); track dayAvailability.dayId) {
                  <div class="availability-day">
                    <div class="day-title-row">
                      <p-checkbox
                        [binary]="true"
                        [ngModel]="dayAvailability.isDayAvailable"
                        (ngModelChange)="onDayAvailabilityToggle(dayAvailability, $event)"
                      ></p-checkbox>
                      <div class="day-title">{{ dayAvailability.dayLabel }}</div>
                    </div>
                    <div class="day-header">
                      <span>{{ formatDayBoundary(dayAvailability.minMinute) }}</span>
                      <strong class="selected-range">{{ formatRange(dayAvailability.range) }}</strong>
                      <span>{{ formatDayBoundary(dayAvailability.maxMinute) }}</span>
                    </div>
                    <p-slider
                      [ngModel]="dayAvailability.range"
                      (ngModelChange)="onDayRangeChange(dayAvailability, $event)"
                      [min]="dayAvailability.minMinute"
                      [max]="dayAvailability.maxMinute"
                      [step]="15"
                      [range]="true"
                      [disabled]="!dayAvailability.isDayAvailable"
                      class="w-full"
                    ></p-slider>
                    <small>
                      {{ 'CONFERENCE.SPEAKERS.EDIT.CALCULATED_UNAVAILABLE' | translate }}: {{ computeDayUnavailableCount(dayAvailability.dayId) }}
                    </small>
                  </div>
                }
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>

        <div class="dialog-actions">
          <button
            pButton
            type="button"
            label="{{ 'COMMON.CANCEL' | translate }}"
            severity="secondary"
            (click)="closeSpeakerEdit()"
          ></button>
          <button
            pButton
            type="button"
            label="{{ 'COMMON.SAVE' | translate }}"
            (click)="saveSpeakerEdit()"
            [loading]="saving()"
            [disabled]="!isSpeakerFormValid(editingPerson())"
          ></button>
        </div>
      </div>
    }
  }
</p-dialog>
