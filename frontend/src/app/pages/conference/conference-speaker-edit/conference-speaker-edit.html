<h2 class="page-title">
  {{
    speakerPageTitleKey()
      | translate
        : {
            conference: ((conference()?.name || '') + (conference()?.edition ? ' ' + conference()?.edition : '')).trim()
          }
  }}
</h2>

@if (!loading()) {
  @if (editingPerson(); as person) {
    <div class="edit-page">
      <div class="page-header">
        <button
          pButton
          type="button"
          icon="pi pi-arrow-left"
          [label]="'COMMON.CANCEL' | translate"
          severity="secondary"
          (click)="closeSpeakerEdit()"
        ></button>
      </div>

      <div class="edit-content">
        <div class="speaker-avatar-row">
          <p-avatar
            [image]="person.speaker?.photoUrl || ''"
            shape="circle"
            size="xlarge"
            [label]="!person.speaker?.photoUrl ? ((person.firstName[0] || '') + (person.lastName[0] || '')) : undefined"
          ></p-avatar>
        </div>

        <p-tabs [value]="0">
          <p-tablist>
            <p-tab [value]="0">{{ 'CONFERENCE.SPEAKERS.EDIT.TAB_PERSON' | translate }}</p-tab>
            <p-tab [value]="1">{{ 'CONFERENCE.SPEAKERS.EDIT.TAB_SPEAKER' | translate }}</p-tab>
            <p-tab [value]="2">{{ 'CONFERENCE.SPEAKERS.EDIT.TAB_SESSIONS' | translate }}</p-tab>
            <p-tab [value]="3">{{ 'CONFERENCE.SPEAKERS.EDIT.TAB_AVAILABILITY' | translate }}</p-tab>
          </p-tablist>
          <p-tabpanels>
            <p-tabpanel [value]="0">
              <div class="form-grid">
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.FIRST_NAME' | translate }}</label>
                  <input pInputText [(ngModel)]="person.firstName" class="w-full" />
                  @if (!isRequiredTextFilled(person.firstName)) {
                    <small>{{ 'VALIDATION.REQUIRED' | translate }}</small>
                  }
                </div>
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.LAST_NAME' | translate }}</label>
                  <input pInputText [(ngModel)]="person.lastName" class="w-full" />
                  @if (!isRequiredTextFilled(person.lastName)) {
                    <small>{{ 'VALIDATION.REQUIRED' | translate }}</small>
                  }
                </div>
                <div class="form-group">
                  <label>{{ 'PERSON.EDIT.EMAIL' | translate }}</label>
                  <input pInputText [(ngModel)]="person.email" type="email" class="w-full" [disabled]="!createMode()" />
                  @if (!createMode()) {
                    <small>{{ 'PERSON.EDIT.EMAIL_DISABLED' | translate }}</small>
                  } @else if (!isRequiredTextFilled(person.email)) {
                    <small>{{ 'VALIDATION.REQUIRED' | translate }}</small>
                  }
                </div>
                <div class="form-group">
                  <label>{{ 'PERSON.EDIT.LANGUAGE' | translate }}</label>
                  <p-select
                    [(ngModel)]="person.preferredLanguage"
                    [options]="languageOptions()"
                    optionLabel="label"
                    optionValue="value"
                    [disabled]="!createMode()"
                    class="w-full"
                  ></p-select>
                </div>
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.COMPANY' | translate }}</label>
                  <input pInputText [(ngModel)]="person.speaker!.company" class="w-full" />
                </div>
                <div class="form-group">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.PHOTO_URL' | translate }}</label>
                  <input pInputText [(ngModel)]="person.speaker!.photoUrl" class="w-full" />
                </div>
              </div>

              <div class="social-links">
                <h4>{{ 'CONFERENCE.SPEAKERS.EDIT.SOCIAL_LINKS' | translate }}</h4>
                @for (socialLink of person.speaker!.socialLinks; track $index) {
                  <div class="social-row">
                    <input pInputText [(ngModel)]="socialLink.network" [placeholder]="'CONFERENCE.SPEAKERS.EDIT.SOCIAL_NETWORK' | translate" />
                    <input pInputText [(ngModel)]="socialLink.url" [placeholder]="'CONFERENCE.SPEAKERS.EDIT.SOCIAL_URL' | translate" />
                    <button
                      pButton
                      type="button"
                      icon="pi pi-trash"
                      severity="danger"
                      [text]="true"
                      (click)="removeSocialLink($index)"
                    ></button>
                  </div>
                }
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  [label]="'CONFERENCE.SPEAKERS.EDIT.ADD' | translate"
                  severity="secondary"
                  (click)="addSocialLink()"
                ></button>
              </div>
            </p-tabpanel>

            <p-tabpanel [value]="1">
              <div class="form-grid">
                <div class="form-group full-row">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.REFERENCE' | translate }}</label>
                  <textarea pTextarea [(ngModel)]="person.speaker!.reference" rows="4" class="w-full"></textarea>
                </div>
                <div class="form-group full-row">
                  <label>{{ 'CONFERENCE.SPEAKERS.EDIT.BIO' | translate }}</label>
                  <textarea pTextarea [(ngModel)]="person.speaker!.bio" rows="4" class="w-full"></textarea>
                </div>
              </div>
            </p-tabpanel>

            <p-tabpanel [value]="2">
              <p-dataview [value]="editingSessionViews()" layout="list">
                <ng-template #list let-items>
                  <div class="speaker-session-list">
                    @for (item of items; track item.id) {
                      <div class="speaker-session-item">
                        <div class="speaker-session-main">
                          <div class="speaker-session-title">{{ item.title }}</div>
                          <div class="speaker-session-speakers">{{ item.speakersLabel }}</div>
                          <div class="speaker-session-slot">
                            @if (item.slotLabel) {
                              {{ item.slotLabel }}
                            } @else {
                              {{ 'CONFERENCE.SPEAKERS.EDIT.SESSION_NOT_ALLOCATED' | translate }}
                            }
                          </div>
                          <div class="speaker-session-badges">
                            <span
                              class="meta-badge"
                              [style.background-color]="item.sessionTypeBackgroundColor"
                              [style.color]="item.sessionTypeTextColor"
                            >
                              {{ item.sessionTypeLabel }}
                            </span>
                            <span
                              class="meta-badge"
                              [style.background-color]="item.trackBackgroundColor"
                              [style.color]="item.trackTextColor"
                            >
                              {{ item.trackLabel }}
                            </span>
                          </div>
                        </div>
                        <div class="speaker-session-status">
                          <app-session-status-badge [status]="item.status"></app-session-status-badge>
                        </div>
                      </div>
                    }
                  </div>
                </ng-template>
                <ng-template #emptymessage>
                  <div class="empty-message">{{ 'CONFERENCE.SPEAKERS.EDIT.SESSIONS_EMPTY' | translate }}</div>
                </ng-template>
              </p-dataview>
            </p-tabpanel>

            <p-tabpanel [value]="3">
              <div class="availability-list">
                @for (dayAvailability of editingDayAvailabilities(); track dayAvailability.dayId) {
                  <div class="availability-day">
                    <div class="day-title-row">
                      <p-checkbox
                        [binary]="true"
                        [ngModel]="dayAvailability.isDayAvailable"
                        (ngModelChange)="onDayAvailabilityToggle(dayAvailability, $event)"
                      ></p-checkbox>
                      <div class="day-title">{{ dayAvailability.dayLabel }}</div>
                    </div>
                    <div class="day-header">
                      <span>{{ formatDayBoundary(dayAvailability.minMinute) }}</span>
                      <strong class="selected-range">{{ formatRange(dayAvailability.range) }}</strong>
                      <span>{{ formatDayBoundary(dayAvailability.maxMinute) }}</span>
                    </div>
                    <p-slider
                      [ngModel]="dayAvailability.range"
                      (ngModelChange)="onDayRangeChange(dayAvailability, $event)"
                      [min]="dayAvailability.minMinute"
                      [max]="dayAvailability.maxMinute"
                      [step]="15"
                      [range]="true"
                      [disabled]="!dayAvailability.isDayAvailable"
                      class="w-full"
                    ></p-slider>
                    <small>
                      {{ 'CONFERENCE.SPEAKERS.EDIT.CALCULATED_UNAVAILABLE' | translate }}: {{ computeDayUnavailableCount(dayAvailability.dayId) }}
                    </small>
                  </div>
                }
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>

        <div class="dialog-actions">
          <button
            pButton
            type="button"
            label="{{ 'COMMON.CANCEL' | translate }}"
            severity="secondary"
            (click)="closeSpeakerEdit()"
          ></button>
          <button
            pButton
            type="button"
            label="{{ 'COMMON.SAVE' | translate }}"
            (click)="saveSpeakerEdit()"
            [loading]="saving()"
            [disabled]="!isSpeakerFormValid(editingPerson())"
          ></button>
        </div>
      </div>
    </div>
  }
}
